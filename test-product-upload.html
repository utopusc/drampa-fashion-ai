<!DOCTYPE html>
<html>
<head>
    <title>Product Upload & Fashion API Test</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        input, select { padding: 10px; margin: 5px; width: 200px; }
        button { padding: 10px 20px; background: #ff6500; color: white; border: none; cursor: pointer; margin: 5px; }
        button:hover { background: #e55500; }
        .log { background: #f0f0f0; padding: 10px; margin-top: 20px; border-radius: 5px; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        #preview { max-width: 300px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Product Upload & Fashion API Test</h1>
        
        <div class="section">
            <h2>1. Test Backend Connection</h2>
            <button onclick="testBackend()">Test Backend API</button>
            <button onclick="testAuth()">Test Authentication</button>
        </div>
        
        <div class="section">
            <h2>2. Upload Product Image</h2>
            <input type="file" id="fileInput" accept="image/*">
            <br>
            <img id="preview" style="display:none;">
            <br>
            <input type="text" id="productName" placeholder="Product Name">
            <select id="productType">
                <option value="top">Top</option>
                <option value="bottom">Bottom</option>
                <option value="dress">Dress</option>
                <option value="outerwear">Outerwear</option>
            </select>
            <br>
            <button onclick="uploadProduct()">Upload Product</button>
        </div>
        
        <div class="section">
            <h2>3. Test Fashion API</h2>
            <input type="text" id="apiKey" placeholder="FASHN API Key (optional)">
            <br>
            <button onclick="testFashnAPI()">Test FASHN API</button>
            <button onclick="getProducts()">Get My Products</button>
        </div>
        
        <div class="log" id="log">
            <strong>Test Log:</strong>
            <div id="results"></div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://31.220.81.177';
        let authToken = null;
        
        const log = (message, type = 'info') => {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
            console.log(message);
        };
        
        // Show image preview
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        const testBackend = async () => {
            log('Testing backend connection...');
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                const data = await response.json();
                log(`‚úÖ Backend is ${data.status}`, 'success');
            } catch (error) {
                log(`‚ùå Backend connection failed: ${error.message}`, 'error');
            }
        };
        
        const testAuth = async () => {
            log('Testing authentication...');
            try {
                const response = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'bruceoz@gmail.com',
                        password: 'Ada1096754!!26'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    log(`‚úÖ Authenticated as ${data.data.user.email}`, 'success');
                } else {
                    log(`‚ùå Auth failed: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Auth error: ${error.message}`, 'error');
            }
        };
        
        const uploadProduct = async () => {
            if (!authToken) {
                log('‚ö†Ô∏è Please authenticate first', 'warning');
                await testAuth();
                if (!authToken) return;
            }
            
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const name = document.getElementById('productName').value;
            const type = document.getElementById('productType').value;
            
            if (!file || !name) {
                log('‚ö†Ô∏è Please select a file and enter a name', 'warning');
                return;
            }
            
            log('Uploading product...');
            
            const formData = new FormData();
            formData.append('image', file);
            formData.append('name', name);
            formData.append('type', type);
            formData.append('category', 'fashion');
            formData.append('description', 'Test product upload');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/products`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`‚úÖ Product uploaded: ${data.product.name}`, 'success');
                    log(`Image URL: ${BACKEND_URL}${data.product.imageUrl}`, 'success');
                    
                    // Test if image is accessible
                    const imgTest = await fetch(`${BACKEND_URL}${data.product.imageUrl}`);
                    if (imgTest.ok) {
                        log('‚úÖ Image is accessible', 'success');
                    } else {
                        log('‚ùå Image not accessible', 'error');
                    }
                } else {
                    log(`‚ùå Upload failed: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Upload error: ${error.message}`, 'error');
            }
        };
        
        const getProducts = async () => {
            if (!authToken) {
                log('‚ö†Ô∏è Please authenticate first', 'warning');
                await testAuth();
                if (!authToken) return;
            }
            
            log('Fetching products...');
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/products`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`‚úÖ Found ${data.products.length} products`, 'success');
                    data.products.forEach(p => {
                        log(`- ${p.name} (${p.type}): ${BACKEND_URL}${p.imageUrl}`);
                    });
                } else {
                    log(`‚ùå Failed to get products: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        };
        
        const testFashnAPI = async () => {
            const apiKey = document.getElementById('apiKey').value || 'fa-whrqHxdK3cKN-bNe7HfPi8eYpJ3PaULanzj5H';
            
            log('Testing FASHN API...');
            log(`Using API Key: ${apiKey.substring(0, 10)}...`);
            
            try {
                // Test with a simple request
                const response = await fetch('https://api.fashn.ai/v1/credits', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ FASHN API Connected`, 'success');
                    log(`Credits: ${data.credits.total} (Sub: ${data.credits.subscription}, On-demand: ${data.credits.on_demand})`, 'success');
                } else {
                    const error = await response.text();
                    log(`‚ùå FASHN API Error: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå FASHN connection error: ${error.message}`, 'error');
                log('This might be a CORS issue. The API should work from the backend.', 'warning');
            }
        };
        
        // Load saved token
        authToken = localStorage.getItem('authToken');
        if (authToken) {
            log('Found saved auth token', 'success');
        }
    </script>
</body>
</html>